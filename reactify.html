<html>
    <head>
        <title>Given | When | Then</title>
        <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet">

        <script src="https://unpkg.com/react@15/dist/react.js"></script>
        <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>

        <link rel="stylesheet" type="text/css" href="./font-awesome-4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" type="text/css" href="./style.css" />
    </head>
    <body>
        <h1 class="header">Given - When - Then</h1>
        <div id="root"></div>

        <script>
            var groupTypes = 
            {
                given: 'Given',
                when: 'When',
                then: 'Then'
            };

            var Row = React.createClass(
            {
                getInitialState: function()
                {
                    return { content : this.props.content };
                },

                onKeyDown: function(event)
                {
                    if (event.key === 'Enter')
                    {
                        event.preventDefault();
                        this.props.onEnter(this.props.index + 1);
                    }
                    else if (event.key === 'Backspace' && event.target.innerText === '')
                    {
                        this.props.onDeleteLine(this.props.index);
                    }
                },

                componentDidMount: function()
                {
                    if (this.props.takeFocus) this.input.focus();
                },

                render: function()
                {
                    var self = this;

                    return React.createElement('div', { className: 'row' },
                        React.createElement('label', null, this.props.label),
                        React.createElement('span', 
                        { 
                            contentEditable: true,
                            onKeyDown: self.onKeyDown, 
                            suppressContentEditableWarning: true,
                            ref: function (element) { self.input = element; }
                        }, this.state.content)
                    );
                }
            });

            var Group = React.createClass(
            {
                getInitialState: function()
                {
                    var counter = 0;

                    return { 
                        rows: this.props.rows.map(function (rowContent) 
                        {
                            return { id: counter++, content: rowContent};
                        }),
                        counter: counter
                    };
                },

                onAddLine: function(index)
                {
                    this.setState(function(previousState)
                    {
                        previousState.rows.splice(index, 0, { id: previousState.counter, content: ''});
                        return { 
                            rows: previousState.rows, 
                            focusId: previousState.counter, 
                            counter: previousState.counter + 1
                        };
                    });
                },

                onDeleteLine: function(index)
                {
                    if (index > 0)
                    {
                        this.setState(function(previousState)
                        {
                            previousState.rows.splice(index, 1);
                            return { 
                                rows: previousState.rows, 
                                focusId: previousState.rows[index - 1].id
                            };
                        });
                    }
                },

                componentDidMount: function()
                {
                    if (this.state.rows.length === 0) 
                        this.setState({ rows: [{ id: 0, content: '' }], counter: 1 });
                },

                render: function()
                {
                    var self = this;

                    return React.createElement('div', { className: 'group ' + this.props.type },
                        this.state.rows.map(function (row, index)
                        {
                            var label = index === 0 ? groupTypes[self.props.type] : 'and';
                            return React.createElement(Row, 
                            {
                                key: row.id, 
                                index: index, 
                                label: label, 
                                content: row.content, 
                                onEnter: self.onAddLine,
                                onDeleteLine: self.onDeleteLine,
                                takeFocus: row.id === self.state.focusId || self.props.takeFocus && index === 0
                            });
                        })
                    );
                }
            });

            var Card = React.createClass(
            {
                onAddCard: function()
                {
                    this.props.onAddCard(this.props.index + 1);
                },

                render: function()
                {
                    return React.createElement('div', null, 
                        React.createElement('div', { className: 'card-wrapper ' + this.props.index },
                            React.createElement('div', { className: 'gwt-card' },
                                React.createElement(Group, { type: 'given', rows: this.props.given, takeFocus: this.props.takeFocus }),
                                React.createElement(Group, { type: 'when', rows: this.props.when  }),
                                React.createElement(Group, { type: 'then', rows: this.props.then  }),
                                React.createElement('div', { className: 'check-off' },
                                    React.createElement('i', { className: 'fa fa-square-o fa-2x' })
                                )
                            )
                        ),
                        React.createElement('div', { className: 'add-card' },
                            React.createElement('i', { className: 'fa fa-plus-circle fa-lg', onClick: this.onAddCard })
                        )    
                    );
                }
            });

            var App = React.createClass(
            {
                getInitialState: function()
                {
                    var counter = 0;

                    return { 
                        cards: this.props.cards.map(function (card)
                        {
                            return { id: counter++, given: card.given, when: card.when, then: card.then };
                        }), 
                        counter: counter
                    };
                },

                onAddCard: function(index)
                {
                    this.setState(function(previousState)
                    {
                        previousState.cards.splice(index, 0, { id: previousState.counter, given: [], when: [], then: [] });
                        return { cards: previousState.cards, counter: previousState.counter + 1, focusId: previousState.counter };
                    });
                },

                render: function()
                {
                    var self = this;

                    var cards = this.state.cards.map(function (card, index)
                    {
                        return React.createElement(Card, 
                        {
                            key: card.id,
                            index: index,
                            given: card.given, 
                            when: card.when, 
                            then: card.then,
                            onAddCard: self.onAddCard,
                            takeFocus: card.id === self.state.focusId
                        });
                    });

                    return React.createElement('div', { className: 'body' }, cards);
                }
            });

            window.onload = function()
            {
                ReactDOM.render(
                    React.createElement(App, { cards: [{ given: [], when: [], then: [] }]}),
                    document.getElementById('root')
                );
            };
        </script>
    </body>
</html>